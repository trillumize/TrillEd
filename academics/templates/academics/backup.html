my app work very well.but the problem is,when  global admin create school  and school admin, when also that school admin login it to school admin site and create teacher or user. i notice all user are showing to all school .so school a can see school b user ,see all school admin username create by global admin too


setting.py

import os
from pathlib import Path
from django.urls import reverse_lazy

# BASE_DIR
BASE_DIR = Path(__file__).resolve().parent.parent

# SECURITY
SECRET_KEY = 'django-insecure-=a$_3ggwxba($hfb^*nhk-8s5m=z41%_h*))wdz3_mg%$-_^00'
DEBUG = True
ALLOWED_HOSTS = ['*']


# SHARED_APPS
SHARED_APPS = (
    "django_tenants",        # must be first
    "schools",               # tenant model
    "globals",               # global admin models
    "accounts",              # <--- move here (user model must be shared!)
    "django.contrib.contenttypes",
    "django.contrib.staticfiles",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.admin",
    "django.contrib.auth",
)

# TENANT APPS
TENANT_APPS = (
    # remove "accounts" here
    "academics",
)

# INSTALLED_APPS
INSTALLED_APPS = list(SHARED_APPS) + list(TENANT_APPS) + ["rest_framework"]

# MIDDLEWARE
MIDDLEWARE = [
    "django_tenants.middleware.main.TenantMainMiddleware",
    "django.middleware.security.SecurityMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
]

# URLS and TEMPLATES
ROOT_URLCONF = "schoolms.urls"

TEMPLATES = [
    {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [],
        "APP_DIRS": True,
        "OPTIONS": {
            "context_processors": [
                "django.template.context_processors.request",
                "django.contrib.auth.context_processors.auth",
                "django.contrib.messages.context_processors.messages",
            ],
        },
    },
]

WSGI_APPLICATION = "schoolms.wsgi.application"

# DATABASE (PostgreSQL + django-tenants)
DATABASES = {
    "default": {
        "ENGINE": "django_tenants.postgresql_backend",
        "NAME": "schoolms",
        "USER": "postgres",
        "PASSWORD": "newpassword",
        "HOST": "localhost",
        "PORT": "5432",
    }
}

DATABASE_ROUTERS = ("django_tenants.routers.TenantSyncRouter",)

# TENANT MODEL
TENANT_MODEL = "schools.Client"
TENANT_DOMAIN_MODEL = "schools.Domain"

# AUTH USER MODELS
# Public schema uses GlobalSuperAdmin
#AUTH_USER_MODEL = "globals.GlobalSuperAdmin"

# AUTH USER MODELS
AUTH_USER_MODEL = "accounts.User"


# PASSWORD VALIDATION
AUTH_PASSWORD_VALIDATORS = [
    {"NAME": "django.contrib.auth.password_validation.UserAttributeSimilarityValidator"},
    {"NAME": "django.contrib.auth.password_validation.MinimumLengthValidator"},
    {"NAME": "django.contrib.auth.password_validation.CommonPasswordValidator"},
    {"NAME": "django.contrib.auth.password_validation.NumericPasswordValidator"},
]

# INTERNATIONALIZATION
LANGUAGE_CODE = "en-us"
TIME_ZONE = "UTC"
USE_I18N = True
USE_TZ = True

# STATIC AND MEDIA
STATIC_URL = "/static/"
STATIC_ROOT = BASE_DIR / "staticfiles"
MEDIA_URL = "/media/"
MEDIA_ROOT = BASE_DIR.parent / "media"

# LOGIN URLS
LOGIN_URL = reverse_lazy("academics:login")
LOGIN_REDIRECT_URL = reverse_lazy("academics:teacher_dashboard")

# EMAIL
EMAIL_BACKEND = "django.core.mail.backends.console.EmailBackend"
DEFAULT_FROM_EMAIL = "school@example.com"
SCHOOL_NAME = "My High School"

# DEFAULT PK
DEFAULT_AUTO_FIELD = "django.db.models.BigAutoField"


school models
from django.db import models
from django_tenants.models import TenantMixin, DomainMixin

class Client(TenantMixin):
    name = models.CharField(max_length=100)
    created_on = models.DateField(auto_now_add=True)
    auto_create_schema = True  # auto creates schema for the school

    # Optional fields for subscription
    on_trial = models.BooleanField(default=True)
    paid_until = models.DateField(null=True, blank=True)

    def __str__(self):
        return self.name


class Domain(DomainMixin):
    pass


    school admin 
    from django.contrib import admin
from django.shortcuts import render, redirect
from django_tenants.utils import schema_context
from .models import Client, Domain
from accounts.models import User
from .forms import TenantAdminForm

@admin.register(Client)
class ClientAdmin(admin.ModelAdmin):
    list_display = ("name", "schema_name", "created_on", "paid_until", "on_trial")
    actions = ["create_tenant_admin"]

    def create_tenant_admin(self, request, queryset):
        """
        Admin action to create a school admin + domain for selected tenants.
        """
        if "apply" in request.POST:   # form submitted
            form = TenantAdminForm(request.POST)
            if form.is_valid():
                username = form.cleaned_data["username"]
                email = form.cleaned_data["email"]
                password = form.cleaned_data["password"]

                for tenant in queryset:
                    # Switch to tenant schema
                    with schema_context(tenant.schema_name):
                        # Create school admin if not already present
                        if not User.objects.filter(username=username).exists():
                            User.objects.create_superuser(
                                username=username,
                                email=email,
                                password=password,
                                role="school_admin"
                            )

                    # Create tenant domain if not already present
                    Domain.objects.get_or_create(
                        domain=f"{tenant.schema_name}.localhost",
                        tenant=tenant,
                        defaults={"is_primary": True}
                    )

                self.message_user(request, f"‚úÖ School admin created: {username} / {password}")
                return redirect(request.get_full_path())
        else:
            form = TenantAdminForm()

        return render(
            request,
            "admin/schools/create_tenant_admin.html",
            context={"form": form, "tenants": queryset},
        )

    create_tenant_admin.short_description = "Create School Admin + Domain for selected schools"

@admin.register(Domain)
class DomainAdmin(admin.ModelAdmin):
    list_display = ("domain", "tenant", "is_primary")
global app 
model
from django.contrib.auth.models import AbstractBaseUser, PermissionsMixin, BaseUserManager
from django.db import models

class GlobalUserManager(BaseUserManager):
    def create_user(self, email, password=None, **extra_fields):
        if not email:
            raise ValueError("Email must be set")
        email = self.normalize_email(email)
        user = self.model(email=email, **extra_fields)
        user.set_password(password)
        user.save(using=self._db)
        return user

    def create_superuser(self, email, password=None, **extra_fields):
        extra_fields.setdefault("is_staff", True)
        extra_fields.setdefault("is_superuser", True)
        return self.create_user(email, password, **extra_fields)


class GlobalSuperAdmin(AbstractBaseUser, PermissionsMixin):
    email = models.EmailField(unique=True)
    first_name = models.CharField(max_length=150)
    last_name = models.CharField(max_length=150)
    is_staff = models.BooleanField(default=True)
    is_active = models.BooleanField(default=True)
    date_joined = models.DateTimeField(auto_now_add=True)

    # fix clash
    groups = models.ManyToManyField(
        'auth.Group',
        related_name="global_superadmins",
        blank=True,
        help_text="Groups this user belongs to."
    )
    user_permissions = models.ManyToManyField(
        'auth.Permission',
        related_name="global_superadmins",
        blank=True,
        help_text="Specific permissions for this user."
    )

    objects = GlobalUserManager()

    USERNAME_FIELD = "email"
    REQUIRED_FIELDS = ["first_name", "last_name"]

    def __str__(self):
        return f"{self.email} ({self.first_name} {self.last_name})"
account add model
from django.contrib.auth.models import AbstractUser
from django.db import models

class User(AbstractUser):
    ROLE_CHOICES = (
        ("global_admin", "Global Admin"),
        ("school_admin", "School Admin"),
        ("teacher", "Teacher"),
        ("student", "Student"),
    )
    role = models.CharField(max_length=20, choices=ROLE_CHOICES, default="student")

    def __str__(self):
        return f"{self.username} ({self.role})"


account admin
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin
from .models import User

@admin.register(User)
class CustomUserAdmin(UserAdmin):
    list_display = ("username", "email", "is_staff", "is_active")
    list_filter = ("is_staff", "is_active")
academics model
from django.db import models
from django.db import models
from django.conf import settings

User = settings.AUTH_USER_MODEL



# academics/models.py
from django.db import models

class School(models.Model):
    name_en = models.CharField(max_length=255, verbose_name="English name")
    name_fr = models.CharField(max_length=255, verbose_name="French name")
    logo = models.ImageField(upload_to="logos/", null=True, blank=True)
    registration_number = models.CharField(max_length=100, blank=True)

    def __str__(self):
        return self.name_en


class ClassRoom(models.Model):
    name = models.CharField(max_length=100)  # e.g. "Form 2A"
    next_class = models.ForeignKey(
        "self",
        null=True,
        blank=True,
        on_delete=models.SET_NULL,
        related_name="previous_class"
    )  # link to the class into which students are promoted

    def __str__(self):
        return self.name

class Subject(models.Model):
    name = models.CharField(max_length=150)
    coefficient = models.FloatField(default=1.0)
    def __str__(self): return self.name

#class TeacherAssignment(models.Model):
 #   teacher = models.ForeignKey(
  #      User,
   #     limit_choices_to={'role': 'teacher'},
    #    on_delete=models.CASCADE
    #)
    #classroom = models.ForeignKey(ClassRoom, on_delete=models.CASCADE)
    #subject = models.ForeignKey(Subject, on_delete=models.CASCADE)

    #class Meta:
     #   unique_together = ('classroom', 'subject')  # <== ‚úÖ change here

    #def __str__(self):
     #   return f"{self.teacher} ‚Üí {self.classroom} ({self.subject})"

from django.db import models
from django.conf import settings
from django.contrib.auth import get_user_model

User = settings.AUTH_USER_MODEL

# -------------------
# Teacher
# -------------------
class Teacher(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE, blank=True, null=True)
    first_name = models.CharField(max_length=150)
    last_name = models.CharField(max_length=150)
    email = models.EmailField(blank=True)
    employee_id = models.CharField(max_length=50, blank=True, null=True)

    def save(self, *args, **kwargs):
        UserModel = get_user_model()
        if not self.user:
            username = f"{self.first_name.lower()}.{self.last_name.lower()}"
            self.user = UserModel.objects.create(
                username=username,
                first_name=self.first_name,
                last_name=self.last_name,
                email=self.email,
                role="teacher",
            )
            self.user.set_password("defaultpassword123")  # change later
            self.user.save()
        super().save(*args, **kwargs)

    def __str__(self):
        return f"{self.first_name} {self.last_name}"

# -------------------
# TeacherAssignment
# -------------------
class TeacherAssignment(models.Model):
    teacher = models.ForeignKey(Teacher, on_delete=models.CASCADE)
    classroom = models.ForeignKey("ClassRoom", on_delete=models.CASCADE)
    subject = models.ForeignKey("Subject", on_delete=models.CASCADE)

    class Meta:
        unique_together = ("classroom", "subject")

    def __str__(self):
        return f"{self.teacher} ‚Üí {self.classroom} ({self.subject})"


class Student(models.Model):
    admission_no = models.CharField(max_length=50, unique=True, null=True, blank=True)
    first_name = models.CharField(max_length=150)
    last_name = models.CharField(max_length=150)
    classroom = models.ForeignKey(ClassRoom, on_delete=models.CASCADE)
    date_of_birth = models.DateField(null=True, blank=True)
    place_of_birth = models.CharField(max_length=150, null=True, blank=True)
    gender = models.CharField(max_length=10, null=True, blank=True)
    photo = models.ImageField(upload_to="student_photos/", null=True, blank=True)
    parent_name = models.CharField(max_length=150, null=True, blank=True)
    parent_contact = models.CharField(max_length=50, null=True, blank=True)  # phone
    parent_email = models.EmailField(null=True, blank=True)  # <-- NEW
    repeater = models.BooleanField(default=False)

    def __str__(self):
        return f"{self.first_name} {self.last_name}"




# models.py
class TermConfig(models.Model):
    TERM_CHOICES = (('first','First'),('second','Second'),('third','Third'))
    year = models.IntegerField()
    term = models.CharField(max_length=10, choices=TERM_CHOICES)
    is_open = models.BooleanField(default=False)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        unique_together = ('year','term')  # Removed 'sequence'

    def __str__(self):
        return f"{self.year} - {self.term}"
class Mark(models.Model):
    student = models.ForeignKey(Student, on_delete=models.CASCADE)
    subject = models.ForeignKey(Subject, on_delete=models.CASCADE)
    teacher = models.ForeignKey(
        User,
        limit_choices_to={'role': 'teacher'},
        on_delete=models.SET_NULL,
        null=True
    )
    year = models.IntegerField()
    term = models.CharField(
        max_length=10,
        choices=(('first', 'First'), ('second', 'Second'), ('third', 'Third'))
    )

    # ‚úÖ Marks only
    sequence1 = models.FloatField(null=True, blank=True)
    sequence2 = models.FloatField(null=True, blank=True)
    sequence3 = models.FloatField(null=True, blank=True)
    sequence4 = models.FloatField(null=True, blank=True)
    sequence5 = models.FloatField(null=True, blank=True)
    sequence6 = models.FloatField(null=True, blank=True)

    # ‚úÖ Computed fields
    term_average = models.FloatField(null=True, blank=True)
    locked = models.BooleanField(default=False)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        unique_together = ('student', 'subject', 'year', 'term')

    def save(self, *args, **kwargs):
        # Compute average for the right term
        seqs = []
        if self.term == 'first':
            seqs = [self.sequence1, self.sequence2]
        elif self.term == 'second':
            seqs = [self.sequence3, self.sequence4]
        elif self.term == 'third':
            seqs = [self.sequence5, self.sequence6]

        valid_seqs = [s for s in seqs if s is not None]
        if valid_seqs:
            self.term_average = sum(valid_seqs) / len(valid_seqs)

        super().save(*args, **kwargs)

    # ‚úÖ Automatic remark from average
    def get_remark(self):
        if self.term_average is None:
            return "No marks yet"
        if self.term_average < 5:
            return "Very poor, needs serious work"
        elif self.term_average < 10:
            return "Weak, must improve"
        elif self.term_average < 14:
            return "Fair, keep trying"
        elif self.term_average < 17:
            return "Good work, continue"
        else:
            return "Excellent, keep it up"

    # ‚úÖ Letter grade from average
    def get_grade(self):
        if self.term_average is None:
            return "-"
        if self.term_average < 5:
            return "F"
        if self.term_average < 10:
            return "E"
        if self.term_average < 14:
            return "D"
        if self.term_average < 17:
            return "C"
        return "A"



class Competency(models.Model):
    subject = models.ForeignKey(Subject, on_delete=models.CASCADE)
    classroom = models.ForeignKey(ClassRoom, on_delete=models.CASCADE)  # <- match class name
    teacher = models.ForeignKey(User, limit_choices_to={'role': 'teacher'}, on_delete=models.CASCADE)
    sequence = models.IntegerField()  # 1,2,3...
    description = models.TextField()

    class Meta:
        unique_together = ('subject', 'classroom', 'teacher', 'sequence')

    def __str__(self):
        return f"{self.subject.name} - {self.classroom.name} - {self.teacher.username} Seq {self.sequence}"




class DisciplineRecord(models.Model):
    student = models.ForeignKey(Student, on_delete=models.CASCADE)
    year = models.IntegerField()
    term = models.CharField(
        max_length=10,
        choices=(('first','First'),('second','Second'),('third','Third'))
    )

    unjustified_absences = models.IntegerField(default=0)
    justified_absences = models.IntegerField(default=0)
    lateness = models.IntegerField(default=0)
    punishment_hours = models.IntegerField(default=0)

    warning = models.BooleanField(default=False)
    reprimand = models.BooleanField(default=False)
    suspension = models.BooleanField(default=False)
    dismissal = models.BooleanField(default=False)

    remark = models.TextField(null=True, blank=True)

    # Prevent duplicate sends
    sent_to_parent = models.BooleanField(default=False)  # <-- NEW

    class Meta:
        unique_together = ('student','year','term')

    def __str__(self):
        return f"Discipline {self.student} - {self.year} {self.term}"

# models.py
from django.db import models

class Leaderboard(models.Model):
    class Meta:
        verbose_name = "Leaderboard"
        verbose_name_plural = "Leaderboards"

    def __str__(self):
        return "Leaderboard"




# academics/models.py
class SubjectEnrollment(models.Model):
    teacher_assignment = models.ForeignKey("TeacherAssignment", on_delete=models.CASCADE)
    student = models.ForeignKey("Student", on_delete=models.CASCADE)

    class Meta:
        unique_together = ("teacher_assignment", "student")

    def __str__(self):
        return f"{self.student} in {self.teacher_assignment.subject} ({self.teacher_assignment.classroom})"


academics admin
from django.contrib import admin
from django.shortcuts import render, redirect
from django.contrib import messages
from django.utils.html import format_html
from django.urls import reverse, path
import pandas as pd
import io
import zipfile
from django.http import HttpResponse

from .models import ClassRoom, Subject, TeacherAssignment, Student, TermConfig, Mark
from .forms import StudentUploadForm

# ----------------------------
# ClassRoomAdmin - Upload Students + Generate Reports
# ----------------------------from django.contrib import admin, messages
from django.shortcuts import render, redirect
from django.utils.html import format_html
from django.urls import reverse, path
from django.http import HttpResponse
from collections import defaultdict
import pandas as pd
import io, zipfile, csv

from .models import ClassRoom, Student, Mark, Subject
from .forms import StudentUploadForm

# admin.py
import datetime
from django.urls import reverse
from django.utils.html import format_html
from django.contrib import admin
from .models import ClassRoom



from django.contrib import admin
from .models import School

@admin.register(School)
class SchoolAdmin(admin.ModelAdmin):
    list_display = ("name_en", "name_fr", "registration_number")

    def has_module_permission(self, request):
        from accounts.utils import user_is_global_admin
        return user_is_global_admin(request.user)

    def has_view_permission(self, request, obj=None):
        return self.has_module_permission(request)

    def has_add_permission(self, request):
        return self.has_module_permission(request)

    def has_change_permission(self, request, obj=None):
        return self.has_module_permission(request)

    def has_delete_permission(self, request, obj=None):
        return self.has_module_permission(request)

@admin.register(ClassRoom)
class ClassRoomAdmin(admin.ModelAdmin):
    list_display = (
        'name',
        'upload_students_link',
        'generate_class_reports_link',
        'marks_overview_link',
        'leaderboard_link',   # ‚úÖ added column
    )

    # ----------------------------
    # Leaderboards Link
    # ----------------------------
    def leaderboard_link(self, obj):
        # ‚úÖ Use current year dynamically
        current_year = datetime.date.today().year  

        try:
            first_term_url = reverse('academics:class_leaderboard', args=[obj.id, current_year, 'first'])
            second_term_url = reverse('academics:class_leaderboard', args=[obj.id, current_year, 'second'])
            third_term_url = reverse('academics:class_leaderboard', args=[obj.id, current_year, 'third'])
        except Exception:
            # fallback if reverse fails (e.g., no URL name yet)
            return "‚ö†Ô∏è Leaderboard URL not found"

        return format_html(
            '<a class="button" href="{}">1st Term</a> '
            '<a class="button" href="{}">2nd Term</a> '
            '<a class="button" href="{}">3rd Term</a>',
            first_term_url, second_term_url, third_term_url
        )

    leaderboard_link.short_description = "Leaderboards"

    
    # ----------------------------
    # Upload Students
    # ----------------------------
    def upload_students_link(self, obj):
        return format_html(
            '<a class="button" href="{}">Upload Students</a>',
            reverse('admin:academics_classroom_upload_students', args=[obj.id])
        )
    upload_students_link.short_description = 'Upload Students'

    def generate_class_reports_link(self, obj):
        return format_html(
            '<a class="button" href="{}">Generate Class Reports</a>',
            reverse('admin:academics_classroom_generate_reports', args=[obj.id])
        )
    generate_class_reports_link.short_description = 'Generate Reports'

    def marks_overview_link(self, obj):
        return format_html(
            '<a class="button" href="{}">View Marks</a>',
            reverse('admin:academics_classroom_marks_overview', args=[obj.id])
        )
    marks_overview_link.short_description = 'Marks Overview'

    def get_urls(self):
        urls = super().get_urls()
        custom_urls = [
            path(
                '<int:classroom_id>/upload-students/',
                self.admin_site.admin_view(self.upload_students),
                name='academics_classroom_upload_students'
            ),
            path(
                '<int:classroom_id>/generate-reports/',
                self.admin_site.admin_view(self.generate_class_reports_view),
                name='academics_classroom_generate_reports'
            ),
            path(
                '<int:classroom_id>/marks-overview/',
                self.admin_site.admin_view(self.marks_overview),
                name='academics_classroom_marks_overview'
            ),
        ]
        return custom_urls + urls

    def upload_students(self, request, classroom_id):
        classroom = self.get_object(request, classroom_id)
        if request.method == "POST":
            form = StudentUploadForm(request.POST, request.FILES)
            if form.is_valid():
                file = form.cleaned_data['file']
                try:
                    if file.name.endswith('.csv'):
                        df = pd.read_csv(file)
                    else:
                        df = pd.read_excel(file)
                except Exception as e:
                    self.message_user(request, f"Error reading file: {e}", level=messages.ERROR)
                    return redirect(request.path)

                required_cols = ['first_name', 'last_name']
                if not all(col in df.columns for col in required_cols):
                    self.message_user(
                        request,
                        "File must contain columns: first_name, last_name",
                        level=messages.ERROR
                    )
                    return redirect(request.path)

                for _, row in df.iterrows():
                    Student.objects.get_or_create(
                        first_name=row['first_name'].strip(),
                        last_name=row['last_name'].strip(),
                        classroom=classroom
                    )
                self.message_user(request, "Students uploaded successfully!", level=messages.SUCCESS)
                return redirect(f"../../{classroom_id}/change/")
        else:
            form = StudentUploadForm()

        return render(
            request,
            "admin/upload_students_form.html",
            {"form": form, "classroom": classroom}
        )

    def generate_class_reports_view(self, request, classroom_id):
        classroom = self.get_object(request, classroom_id)
        students = Student.objects.filter(classroom=classroom)
        from .views import generate_report_card

        zip_buffer = io.BytesIO()
        with zipfile.ZipFile(zip_buffer, 'w') as zip_file:
            for student in students:
                response = generate_report_card(request, student.id, 2025, 'first')
                zip_file.writestr(
                    f"{student.first_name}_{student.last_name}_report.pdf",
                    response.content
                )

        zip_buffer.seek(0)
        response = HttpResponse(zip_buffer, content_type='application/zip')
        response['Content-Disposition'] = f'attachment; filename={classroom.name}_reports.zip'
        return response

    # ----------------------------
    # Marks Overview (NEW)
    # ----------------------------
    def marks_overview(self, request, classroom_id):
        classroom = self.get_object(request, classroom_id)

        # query params
        mode = request.GET.get('mode', 'student')  # 'student' or 'subject'
        subject_id = request.GET.get('subject')
        year = request.GET.get('year')
        term = request.GET.get('term')
        sequence_filter = request.GET.get('sequence')
        export_csv = request.GET.get('export') == 'csv'

        students = Student.objects.filter(classroom=classroom).order_by('last_name', 'first_name')

        marks_qs = Mark.objects.filter(student__classroom=classroom).select_related('student', 'subject')
        if subject_id:
            marks_qs = marks_qs.filter(subject_id=subject_id)
        if year:
            marks_qs = marks_qs.filter(year=year)
        if term:
            marks_qs = marks_qs.filter(term=term)

        marks_by_student = defaultdict(list)
        for m in marks_qs:
            marks_by_student[m.student_id].append(m)

        data = []

        if mode == 'subject':
            for st in students:
                for m in marks_by_student.get(st.id, []):
                    row = {
                        'student': f"{st.last_name} {st.first_name}",
                        'subject': m.subject.name if m.subject else '',
                        'seq1': m.sequence1 or '',
                        'seq2': m.sequence2 or '',
                        'seq3': m.sequence3 or '',
                        'seq4': m.sequence4 or '',
                        'seq5': m.sequence5 or '',
                        'seq6': m.sequence6 or '',
                    }
                    if sequence_filter and not row.get(f'seq{sequence_filter}'):
                        continue
                    data.append(row)
        else:
            for st in students:
                sums = [0.0] * 7
                counts = [0] * 7
                for m in marks_by_student.get(st.id, []):
                    for i in range(1, 7):
                        val = getattr(m, f'sequence{i}', None)
                        if val not in (None, ''):
                            try:
                                v = float(val)
                            except Exception:
                                v = None
                            if v is not None:
                                sums[i] += v
                                counts[i] += 1
                row = {'student': f"{st.last_name} {st.first_name}"}
                for i in range(1, 7):
                    row[f'seq{i}'] = round(sums[i] / counts[i], 2) if counts[i] else ''
                if sequence_filter and not row.get(f'seq{sequence_filter}'):
                    continue
                data.append(row)

        subjects = Subject.objects.filter(mark__student__classroom=classroom).distinct()
        years = Mark.objects.filter(student__classroom=classroom).values_list('year', flat=True).distinct()
        terms = Mark.objects.filter(student__classroom=classroom).values_list('term', flat=True).distinct()

        # CSV export
        if export_csv:
            csv_buffer = io.StringIO()
            writer = csv.writer(csv_buffer)
            headers = ['Student']
            if mode == 'subject':
                headers.append('Subject')
            headers += [f"Sequence {i}" for i in range(1, 6 + 1)]
            writer.writerow(headers)
            for row in data:
                out = [row['student']]
                if mode == 'subject':
                    out.append(row.get('subject', ''))
                out += [row.get(f'seq{i}', '') for i in range(1, 7)]
                writer.writerow(out)
            resp = HttpResponse(csv_buffer.getvalue(), content_type='text/csv')
            resp['Content-Disposition'] = f'attachment; filename="{classroom.name}_marks_overview.csv"'
            return resp

        return render(
            request,
            "admin/marks_overview.html",
            {
                "classroom": classroom,
                "data": data,
                "mode": mode,
                "subjects": subjects,
                "years": sorted(list(set(years))),
                "terms": sorted(list(set(terms))),
                "selected_subject": int(subject_id) if subject_id else None,
                "selected_year": year,
                "selected_term": term,
                "sequence_filter": sequence_filter,
            }
        )

   

# ----------------------------
# SubjectAdmin
# ----------------------------
@admin.register(Subject)
class SubjectAdmin(admin.ModelAdmin):
    list_display = ('name', 'coefficient')

# ----------------------------
# TeacherAssignmentAdmin
# ----------------------------

# ----------------------------
# TermConfigAdmin
# ----------------------------
@admin.register(TermConfig)
class TermConfigAdmin(admin.ModelAdmin):
    list_display = ('year', 'term', 'is_open')
    list_filter = ('year', 'term')

# ----------------------------
# MarkAdmin
# ----------------------------
#@admin.register(Mark)
#class MarkAdmin(admin.ModelAdmin):
 #   list_display = (
  #      'student', 'subject', 'year', 'term',
   #     'sequence_display1', 'sequence_display2',
    #    'sequence_display3', 'sequence_display4',
     #   'sequence_display5', 'sequence_display6',
      #  'term_average', 'teacher', 'locked'
    #)
    #list_filter = ('year', 'term', 'subject', 'student__classroom')
    #search_fields = ('student__first_name', 'student__last_name', 'subject__name')

    # --------------------------
    # Prevent editing
    # --------------------------
    #def has_add_permission(self, request):
     #   return False   # prevent adding

    #def has_change_permission(self, request, obj=None):
     #   return False   # prevent editing

    #def has_delete_permission(self, request, obj=None):
     #   return False   # prevent deletion

    # --------------------------
    # Sequence display columns
    # --------------------------
    #def sequence_display1(self, obj):
     #   return obj.sequence1 if obj.term == 'first' else ''
    #sequence_display1.short_description = "Sequence 1"

    #def sequence_display2(self, obj):
     #   return obj.sequence2 if obj.term == 'first' else ''
    #sequence_display2.short_description = "Sequence 2"

    #def sequence_display3(self, obj):
     #   return obj.sequence3 if obj.term == 'second' else ''
    #sequence_display3.short_description = "Sequence 3"

    #def sequence_display4(self, obj):
     #   return obj.sequence4 if obj.term == 'second' else ''
    #sequence_display4.short_description = "Sequence 4"

    #def sequence_display5(self, obj):
     #   return obj.sequence5 if obj.term == 'third' else ''
    #sequence_display5.short_description = "Sequence 5"

    #def sequence_display6(self, obj):
     #   return obj.sequence6 if obj.term == 'third' else ''
    #sequence_display6.short_description = "Sequence 6"

# ----------------------------
# StudentAdmin
# ----------------------------
@admin.register(Student)
class StudentAdmin(admin.ModelAdmin):
    list_display = ('first_name', 'last_name', 'get_classroom', 'generate_report_link', 'progress_link')
    list_filter = ('classroom',)
    search_fields = ('first_name', 'last_name', 'admission_no', 'parent_contact', 'parent_name')

    def get_classroom(self, obj):
        return obj.classroom.name
    get_classroom.short_description = 'Class'

    def generate_report_link(self, obj):
        url = reverse('academics:generate_report_card', args=[obj.id, 2025, 'first'])
        return format_html('<a class="button" href="{}">Generate Report</a>', url)
    generate_report_link.short_description = 'Report Card'


    def progress_link(self, obj):
        url = reverse('academics:student_progress_view', args=[obj.id])
        return format_html('<a class="button" href="{}">Progress</a>', url)
    progress_link.short_description = 'Progress'


def marks_overview(self, request, classroom_id):
    classroom = self.get_object(request, classroom_id)
    # basic query params
    mode = request.GET.get('mode', 'student')  # 'student' or 'subject'
    subject_id = request.GET.get('subject')
    year = request.GET.get('year')
    term = request.GET.get('term')
    sequence_filter = request.GET.get('sequence')  # '1'..'6' or None
    export_csv = request.GET.get('export') == 'csv'

    # students in the classroom
    students = Student.objects.filter(classroom=classroom).order_by('last_name', 'first_name')

    # base marks queryset limited to this classroom
    marks_qs = Mark.objects.filter(student__classroom=classroom)
    if subject_id:
        marks_qs = marks_qs.filter(subject_id=subject_id)
    if year:
        marks_qs = marks_qs.filter(year=year)
    if term:
        marks_qs = marks_qs.filter(term=term)
    marks_qs = marks_qs.select_related('student', 'subject')

    # group marks by student for fast lookup
    marks_by_student = defaultdict(list)
    for m in marks_qs:
        marks_by_student[m.student_id].append(m)

    data = []  # rows that will be rendered or exported

    if mode == 'subject':
        # one row per (student, subject)
        for st in students:
            for m in marks_by_student.get(st.id, []):
                row = {
                    'student_id': st.id,
                    'student': f"{st.last_name} {st.first_name}",
                    'subject': m.subject.name if m.subject else '',
                    'seq1': m.sequence1 if getattr(m, 'sequence1', None) not in (None, '') else '',
                    'seq2': m.sequence2 if getattr(m, 'sequence2', None) not in (None, '') else '',
                    'seq3': m.sequence3 if getattr(m, 'sequence3', None) not in (None, '') else '',
                    'seq4': m.sequence4 if getattr(m, 'sequence4', None) not in (None, '') else '',
                    'seq5': m.sequence5 if getattr(m, 'sequence5', None) not in (None, '') else '',
                    'seq6': m.sequence6 if getattr(m, 'sequence6', None) not in (None, '') else '',
                }
                # apply sequence filter if requested
                if sequence_filter and not row.get(f'seq{sequence_filter}'):
                    continue
                data.append(row)
    else:
        # student mode ‚Äî average across subjects for each sequence
        for st in students:
            sums = [0.0] * 7   # index 1..6
            counts = [0] * 7
            for m in marks_by_student.get(st.id, []):
                for i in range(1, 7):
                    val = getattr(m, f'sequence{i}', None)
                    if val not in (None, ''):
                        try:
                            v = float(val)
                        except Exception:
                            v = None
                        if v is not None:
                            sums[i] += v
                            counts[i] += 1
            row = {
                'student_id': st.id,
                'student': f"{st.last_name} {st.first_name}",
            }
            for i in range(1, 7):
                if counts[i]:
                    row[f'seq{i}'] = round(sums[i] / counts[i], 2)
                else:
                    row[f'seq{i}'] = ''
            if sequence_filter and not row.get(f'seq{sequence_filter}'):
                continue
            data.append(row)

    # lists for the filter dropdowns in the template
    subjects = Subject.objects.filter(mark__student__classroom=classroom).distinct()
    years = Mark.objects.filter(student__classroom=classroom).values_list('year', flat=True).distinct()
    terms = Mark.objects.filter(student__classroom=classroom).values_list('term', flat=True).distinct()

    # CSV export
    if export_csv:
        csv_buffer = io.StringIO()
        writer = csv.writer(csv_buffer)
        headers = ['Student']
        if mode == 'subject':
            headers.append('Subject')
        headers += [f"Sequence {i}" for i in range(1, 7)]
        writer.writerow(headers)
        for row in data:
            out = [row['student']]
            if mode == 'subject':
                out.append(row.get('subject', ''))
            out += [row.get(f'seq{i}', '') for i in range(1, 7)]
            writer.writerow(out)
        resp = HttpResponse(csv_buffer.getvalue(), content_type='text/csv')
        resp['Content-Disposition'] = f'attachment; filename="{classroom.name}_marks_overview.csv"'
        return resp

    context = {
        'classroom': classroom,
        'data': data,
        'mode': mode,
        'subjects': subjects,
        'years': sorted(list(set(years))),
        'terms': sorted(list(set(terms))),
        'selected_subject': int(subject_id) if subject_id else None,
        'selected_year': year,
        'selected_term': term,
        'sequence_filter': sequence_filter,
    }
    return render(request, "admin/marks_overview.html", context)




from .models import Competency, DisciplineRecord

# ----------------------------
# CompetencyAdmin
# ----------------------------
@admin.register(Competency)
class CompetencyAdmin(admin.ModelAdmin):
    list_display = ('subject', 'description')
    list_filter = ('subject',)
    search_fields = ('description',)

# ----------------------------
# DisciplineRecordAdmin
# ----------------------------
# academics/admin.py
from django.contrib import admin
from .models import DisciplineRecord
from .notifications import send_discipline_report


#@admin.register(DisciplineRecord)
#class DisciplineRecordAdmin(admin.ModelAdmin):
    #list_display = (
        #"student", "year", "term",
       # "unjustified_absences", "justified_absences",
      #  "lateness", "punishment_hours",
     #   "sent_to_parent",   # ‚úÖ Show if report was sent
    #)
    #list_filter = ("year", "term", "student__classroom")
    #search_fields = ("student__first_name", "student__last_name")

    #actions = ["send_to_parents"]

    # ‚úÖ Custom admin action
    #def send_to_parents(self, request, queryset):
        #sent = 0
        #skipped = 0
        #for record in queryset:
            #if not record.sent_to_parent:  # avoid duplicates
           #     send_discipline_report(record)
          #      sent += 1
         #   else:
        #        skipped += 1

       # self.message_user(
      #      request,
     #       f"‚úÖ {sent} report(s) sent. ‚è≠Ô∏è {skipped} skipped (already sent)."
    #    )

   # send_to_parents.short_description = "üì§ Send discipline reports to parents"
from django.contrib import admin
from django.utils.html import format_html
from .models import DisciplineRecord
from .notifications import build_discipline_message
import urllib.parse

@admin.register(DisciplineRecord)
class DisciplineRecordAdmin(admin.ModelAdmin):
    list_display = (
        'student', 'year', 'term',
        'unjustified_absences', 'justified_absences',
        'lateness', 'punishment_hours',
        'whatsapp_link',  # ‚úÖ Added WhatsApp link
    )
    list_filter = ('year', 'term', 'student__classroom')
    search_fields = ('student__first_name', 'student__last_name')

    def whatsapp_link(self, obj):
        student = obj.student
        phone = student.parent_contact
        if not phone:
            return "No contact"

        # Remove non-digit characters
        phone = ''.join(filter(str.isdigit, phone))

        # Ensure it has Cameroon country code
        if not phone.startswith("237"):
            phone = "237" + phone[-9:]  # last 9 digits of local number

        # Build message
        message = build_discipline_message(student, obj)

        # URL-encode message
        encoded_message = urllib.parse.quote(message)

        # WhatsApp link
        url = f"https://web.whatsapp.com/send?phone={phone}&text={encoded_message}"
        return format_html('<a href="{}" target="_blank">Send WhatsApp</a>', url)

    whatsapp_link.short_description = "WhatsApp"






# academics/admin.py  (inside your SchoolAdmin)
from django import forms
from django.urls import path, reverse
from django.shortcuts import render, redirect
from django.contrib import messages
from django.contrib.auth import get_user_model

class CreateSchoolAdminForm(forms.Form):
    username = forms.CharField()
    email = forms.EmailField(required=False)
    first_name = forms.CharField(required=False)
    last_name = forms.CharField(required=False)
    password = forms.CharField(widget=forms.PasswordInput)

def get_urls(self):
    urls = super().get_urls()
    custom = [
        path('<int:school_id>/create-school-admin/', self.admin_site.admin_view(self.create_school_admin), name='academics_school_create_school_admin'),
    ]
    return custom + urls

def create_school_admin(self, request, school_id):
    school = self.get_object(request, school_id)
    if request.method == "POST":
        form = CreateSchoolAdminForm(request.POST)
        if form.is_valid():
            User = get_user_model()
            u = User.objects.create_user(
                username=form.cleaned_data['username'],
                email=form.cleaned_data['email'],
                first_name=form.cleaned_data.get('first_name', ''),
                last_name=form.cleaned_data.get('last_name', ''),
                password=form.cleaned_data['password'],
            )
            # flags: staff but NOT superuser
            u.is_staff = True
            # your user model or profile field:
            if hasattr(u, 'is_school_admin'):
                u.is_school_admin = True
                u.school = school
            else:
                # if using profile
                u.profile.is_school_admin = True
                u.profile.school = school
                u.profile.save()
            u.save()
            messages.success(request, "School admin created")
            return redirect(reverse("admin:academics_school_change", args=[school_id]))
    else:
        form = CreateSchoolAdminForm()
    return render(request, "admin/create_school_admin.html", {"form": form, "school": school})













from django.contrib import admin
from .models import Teacher, TeacherAssignment, ClassRoom, Subject, Student

# -------------------
# Teacher admin
# -------------------
from django import forms
from django.contrib import admin
from django.contrib.auth import get_user_model
from .models import Teacher

# ----------------------------
# Custom form for TeacherAdmin
# ----------------------------
class TeacherAdminForm(forms.ModelForm):
    class Meta:
        model = Teacher
        exclude = ('user',)  # hide the user field entirely

# ----------------------------
# TeacherAdmin
# ----------------------------
@admin.register(Teacher)
class TeacherAdmin(admin.ModelAdmin):
    form = TeacherAdminForm
    list_display = ("first_name", "last_name", "email", "employee_id")
    search_fields = ("first_name", "last_name", "email", "employee_id")

    def save_model(self, request, obj, form, change):
        """
        Automatically create a linked User for the Teacher if it doesn't exist.
        """
        User = get_user_model()

        if not obj.user_id:
            # Create a username based on email or employee_id
            username = obj.email if obj.email else obj.employee_id

            # Make sure the username is unique
            counter = 1
            base_username = username
            while User.objects.filter(username=username).exists():
                username = f"{base_username}{counter}"
                counter += 1

            # Create the user
            user = User.objects.create_user(
                username=username,
                email=obj.email,
                password='DefaultPassword123!'  # ideally, send to teacher to reset
            )
            obj.user = user

        super().save_model(request, obj, form, change)

# -------------------
# TeacherAssignment admin
# -------------------
@admin.register(TeacherAssignment)
class TeacherAssignmentAdmin(admin.ModelAdmin):
    list_display = ("teacher", "classroom", "subject")
    list_filter = ("classroom", "subject", "teacher")
    search_fields = ("teacher__first_name", "teacher__last_name", "classroom__name", "subject__name")




































